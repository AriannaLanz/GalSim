\documentclass[preprint]{aastex}

% packages for figures
\usepackage{graphicx}
% packages for symbols
\usepackage{latexsym,amssymb,hyperref}
% AMS-LaTeX package for e.g. subequations
\usepackage{amsmath}

%=====================================================================
% FRONT MATTER
%=====================================================================

\slugcomment{Draft \today}

%=====================================================================
% BEGIN DOCUMENT
%=====================================================================

\newcommand{\kmax}{\ensuremath{k_\mathrm{max}}}
\newcommand{\kmin}{\ensuremath{k_\mathrm{min}}}
\newcommand{\rmd}{\ensuremath{\mathrm{d}}}
\newcommand{\beq}{\begin{equation}}
\newcommand{\eeq}{\end{equation}}

\begin{document}

\title{Lensing engine testing and normalization convention (Issue \#248)}

\begin{abstract}
This document contains Rachel's notes on tests of the lensing engine
for GalSim Issue \#248.  There are a number of questions we need to
check to make sure that that software is doing what we want it to do,
and all the relevant tests and equations are described below.
\end{abstract}

\section{Introduction}

There are a few issues that we wish to check regarding the lensing
engine.  They are:

\begin{enumerate}
\item $k$ definitions: the lensing engine seems to omit the $2\pi$
  factor that seems standard, i.e., normally we say for some length
  scale $x$ the corresponding $k$ should be $2\pi/x$ but the lensing
  engine in its current form does $1/x$.
\item Overall normalization of shear variance: Currently the shear
  variance for a constant input shear power does not depend on
  the grid size/shape.  This seems non-standard, so we should
  investigate and understand this further.
\item We need to check the scaling of either the observed correlation
  function or power spectrum with $k$, to make sure it is done right.
\item We must check whether unit conversions are done properly.
  GalSim works in terms of arcsec, but it's common to input numbers in
  terms of radians, so we should make sure that this works.
\item What is the effect of interpolating between grid points?  does
  the interpolant have the expected impact on the shear power?
\item If we put in just $E$ or just $B$ mode power with a flat
  spectrum, the variances of $\gamma_1^2$ and $\gamma_2^2$ differ; is
  this expected for a flat power spectrum or sign of a problem?
\item We should make sure that when we use both $E$ and $B$ mode
  power, that we get the expected result, and that results with only
  $E$ or only $B$ are also sane.
\item Impact of differences between continuous vs. discrete
  representation?
\end{enumerate}

\section{Theory}

The lensing engine requires a shear power spectrum, $P(k)$.  We are
working in the flat-sky limit, so when we see expressions in terms of
$\ell$ we can swap $\ell$ with $k$ and $C_\ell$ with $P$, and
\beq
\Delta^2 = \frac{\ell(\ell+1) C_{\ell}}{2\pi}\equiv \frac{k^2 P(k)}{2\pi}.
\eeq
When people plot shear power spectra they usually actually plot
$\Delta^2(k)$ (or, in terms of the full-sky formalism, they plot $\ell(\ell+1)C_\ell/(2\pi)$).

If we identify pairs of galaxies and get the shears in a coordinate
system defined along the vector connecting them ($\gamma_+$) and at 45
degrees with respect to it ($\gamma_\times$), then we can compute
correlation functions of the $\gamma_+$ and $\gamma_\times$ values,
which we will call $\xi_{++}$ and $\xi_{\times\times}$.  Then the
standard cosmological correlation functions $\xi_{\pm}$ are defined as
\begin{align}
\xi_{\pm}(\theta) &=  \xi_{++}\pm \xi_{xx} \\
 &= \frac{1}{2\pi}\int k\,\rmd k P(k) J_{0/4}(k\theta).
\end{align}

Since correlation functions are dimensionless, we immediately see that
$P(k)$ has dimensions of angle$^2$ and $\Delta^2(k)$ is dimensionless.

The variance of the shear values, 
\beq
\mathrm{Var}(\gamma) = \langle g_1^2 + g_2^2\rangle,
\eeq
is essentially $\xi_+(\theta=0)$.   Note that this is what we get for
the defined $\xi_+$ in the limit of $\theta$ going to zero, but that
equation was defined in terms of $\gamma_+$ and $\gamma_\times$ rather
than $\gamma_1$ and $\gamma_2$.  On a grid, it's not clear that we
can enforce/check behavior of Var($\gamma_1$) or Var($\gamma_2)$,
particularly if the corners are important (which will be the case if
there is a lot of shear power at small $k$), probably we should 
 only expect normal behavior for Var($\gamma$), but it's still worth
 verifying this.  So, combining several equations,
\beq\label{E:shearvar}
\mathrm{Var}(\gamma) = \frac{1}{2\pi}\int k\,\rmd k P(k).
\eeq
which essentially says the shear variance is the power integrated over
the allowed area in $k$ space.  I {\em think} that if we want to work
in terms of $k_x$ and $k_y$, we can replace $2\pi k\rmd k$
(integrating within a circle) with $\rmd
k_x \rmd k_y$ (integrating within our square grid), so the above might also be
written as
\beq\label{E:alt-shearvar}
\mathrm{Var}(\gamma) = \frac{1}{(2\pi)^2} \int \rmd k_x \rmd k_y
P(k_x, k_y).
\eeq

None of these integrals have had limits on them.  Formally they should
go from the minimum to the maximum accessible $k$ on our grid.  Our
grid is defined by
\begin{align}
L &= \mbox{length of grid along one dimension (angular units)}\\
d &= \mbox{spacing between grid points (angular units)}\\
N &= \mbox{number of grid points along one dimension} = L/d
\end{align}

In all of the above I have simply written $P(k)$ but in principle there can be
two such functions, $P_{E}$ and $P_B$.  I believe these
should simply be summed in the above variance equation, but should check this.

A note about something possibly confusing: there are many papers that
write equations for shear variances that include some window function,
which we haven't included here.  I believe that is okay, because those
papers are referring to a different calculation: they are averaging
the shear in some cells, and computing the expected variance of those
shears that have been averaged in cells.  In contrast, we're computing
the variance of individual shears that have been defined within our
grid, which is a completely different thing.

\section{Comparison software}

We will compare against a completely independent piece of software,
Chris Hirata's spherical harmonic transform code which is described in
multiple papers (for example,
\href{http://adsabs.harvard.edu/abs/2004PhRvD..70j3501H}{Hirata
  et~al. 2004}).  This does not use the flat-sky
approach, but that should not be huge important of a difference even
for our $L=10$ deg.  It is something to bear in mind if we start
looking for agreement at a few \% level on the largest $\theta$ or
smallest $k$.  This software wants $C_\ell(\ell)$ as its inputs.

\section{Test of constant $\Delta^2(k)$}

Our first test uses a constant value for $\Delta^2(k)=P_0$ (where
$P_0$ is dimensionless), or
$P(k)=2\pi P_0/k^2$ (which has a ton of power on large scales, so not
very realistic, but at least the integrals are easy to do).  Putting this into Eq.~\ref{E:shearvar},
we expect a shear variance of
\begin{align}
\mathrm{Var}(\gamma) &= P_0 \int \frac{\rmd k}{k} \\
 &= P_0 \ln{\left(\frac{\kmax}{\kmin}\right)}.
\end{align}

Note that since this depends on a ratio of $k$'s, it doesn't matter
what units we use for defining our grids, only on the number of grid
points.  We have, for a grid\footnote{Note that I'm using what I think
  the $k$ definition should be, i.e., with a $2\pi$.  That's not
  what's in the code right now.},
\begin{align}
\kmax &= \frac{2\pi}{d} \\
\kmin &= \frac{2\pi}{\sqrt{2}L} \qquad\qquad\mathrm{(2d)}\label{E:kmin2d}\\
\kmin &= \frac{2\pi}{L}  \qquad\qquad\mathrm{ (1d)}\label{E:kmin1d}\\
\frac{\kmax}{\kmin} &= \sqrt{2}N.
\end{align}
There are two different \kmin's, depending on whether you are talking
about the maximum $|k|$ (1st option) or the maximum $k_x$ or $k_y$
(2nd options).

So we expect a shear variance defined over both components that is
\beq\label{E:var-test1}
\mathrm{Var}(\gamma) = \ln{(\sqrt{2}N)} P_0.
\eeq

Alternatively if we use Eq.~\ref{E:alt-shearvar}, we expect
\beq
\mathrm{Var}(\gamma) = \frac{P_0}{2\pi} \int \frac{\rmd k_x \rmd k_y}{k_x^2+k_y^2}
\eeq
and I don't think this is a very nice integral that can be done
analytically. 

Chris's SHT code seems to give the result from Eq~\ref{E:var-test1}, as tested using
two grid sizes.  If we try it with GalSim, using $P_0=0.01$, we can
use this code:
\begin{verbatim}
import galsim
import numpy as np
test_ps = galsim.PowerSpectrum(lambda k : 0.01*2.*np.pi/k**2)
g1, g2 = test_ps.buildGriddedShears(grid_spacing=360., ngrid=100)
print np.var(g1), np.var(g2), np.var(g1)+np.var(g2)
g1, g2 = test_ps.buildGriddedShears(grid_spacing=360., ngrid=50)
print np.var(g1), np.var(g2), np.var(g1)+np.var(g2)
g1, g2 = test_ps.buildGriddedShears(grid_spacing=720., ngrid=50)
print np.var(g1), np.var(g2), np.var(g1)+np.var(g2)
\end{verbatim}

The result for the variances over both components in the three cases
should, for consistency with Chris's code, be 2.65, 2.30, 2.30.
However, we instead get large numbers, of order $2\times 10^5$,
$2\times 10^5$, and $6\times 10^5$.

\section{Test of constant shear power}

Constant shear power is also rather unrealistic and leads to a lot of
emphasis on the large scales corresponding to box diagonals.  Let's
instead try this with $P(k) = 4\pi P_2$ (where $P_2$ has dimensions of ang$^2$), or $\Delta^2(k) =
2 P_2 k^2$.  Again going back to Eq.~\ref{E:shearvar},
we expect a shear variance of
\begin{align}
\mathrm{Var}(\gamma) &= 2 P_2 \int k\,\rmd k\\
 &= P_2 (\kmax^2-\kmin^2)\label{E:shearvar-c1}
\end{align}
where here the \kmin\ is the 2d version (Eq.~\ref{E:kmin2d}).

If we use Eq.~\ref{E:alt-shearvar}, then we'd expect
\begin{align}
\mathrm{Var}(\gamma) &= \frac{P_2}{\pi} \int \rmd k_x \rmd k_y\\
  &= \frac{P_2(\kmax-\kmin)^2}{\pi}\label{E:shearvar-c2}
\end{align}
where here the \kmin\ is the 1d version  (Eq.~\ref{E:kmin1d}).

I start with Chris's code, which wants $\ell$ and $C_\ell$ in units of
radians, and use $P_2=0.01$ radians$^2$ for $E$ mode (no $B$ mode
power).  

If we calculate our expectations using Eqs.~\ref{E:shearvar} and~\ref{E:shearvar-c1}, then when
using our default grid that is $10\times 10$ deg with $N=100$ per
dimension, then in terms of radians, we have $\kmin\sim 25.46$ and
$\kmax=3600$, so we expect shear variance (over both components) of
$1.3\times 10^5$.  For a grid that covers $5\times 5$ deg with $N=50$,
then $\kmin$ doubles but $\kmax$ is the same, so the shear variance
should be nearly identical (to sub-percent level).  For a third grid
that covers the same area as original but with $N=50$, $\kmin$ is same
as for the first grid, but $\kmax$ is halved, so the shear variance
should decrease by a factor of $\sim 4$.  

If we calculate our expectations using Eqs.~\ref{E:alt-shearvar} and~\ref{E:shearvar-c2}, then
we have to use $\kmin=36$ (the 1d version) but it's also a different
equation, which gives for the default grid $4\times 10^4$.  For the
second and third grids, our expectations are $4\times 10^4$ and $10^4$.

Result: in all {\em three} cases Chris's code gives a shear variance
of $1.3\times 10^5$!  This is equal to our expectations when using
Eq.~\ref{E:shearvar} in the first two cases, perplexing for the last
one.

For GalSim, I want to start {\em without} testing our unit conversion,
so I am going to convert to arcsec in advance.  We had $P_2=0.01$
radian$^2$, so I will first convert it to
$P_2=0.01 (3600(180/\pi))^2=4.2545\times 10^8$ arcsec$^2$ and
$P(k)=4\pi P_2 = 5.35\times 10^9$ arcsec$^2$ before trying this in
GalSim.  For GalSim I will also try the calculation for the three
types of grids:
\begin{verbatim}
import galsim
import numpy as np
test_ps = galsim.PowerSpectrum(lambda k : 5.35e9 + np.zeros_like(k))
g1, g2 = test_ps.buildGriddedShears(grid_spacing=360., ngrid=100)
print np.var(g1), np.var(g2), np.var(g1)+np.var(g2)
g1, g2 = test_ps.buildGriddedShears(grid_spacing=360., ngrid=50)
print np.var(g1), np.var(g2), np.var(g1)+np.var(g2)
g1, g2 = test_ps.buildGriddedShears(grid_spacing=720., ngrid=50)
print np.var(g1), np.var(g2), np.var(g1)+np.var(g2)
\end{verbatim}
The result is that the variances (over both components) are equal to
the input $P(k)$.  This was the behavior that we have observed before.  {\em Barney, you tried explaining
  this in words, but would you be willing to take a stab at an
  equation??  How is the area factor in $k$ space going away?}

\textbf{Barney's response}:

First, I just realised something I should have pointed out before: in
our PS code $k_{\rm min} = 0$, since this is the power represented by
the $(0, 0)$ matrix element of the array.  The stepsize in $k$, which
we have tend to refer to as $\Delta k$, is $2 \pi / L$.  If you
(somehow) ignored the $k=0$ element, or set it to zero, then I suppose
the minimum $k$ would depend on whether you looked in rectilinear or diagonal direction,
the smallest values being $k_{1, \rm min} = k_{2, \rm min} = 2 \pi / L$.

This has fairly profound implications for the results of the tests of constant
$\Delta^2(k)$.  Indeed it suggests that the variance formally diverges for such
a power spectrum, so it's probably not a good test case of our PS
code and it may be a good sign that...  Just one question though: how did you assign a value of $P(k) = 2 \pi
P_0/ k^2$ for the $k = k_x = k_y = 0$ element?  If you set it to zero
then I think we should have expected better, but not matching, performance.

The fact that Chris's code is giving good results suggests that what
is here being called $k_{\rm min}$ is indeed being interpreted as
such, and Chris has put an option to allow you to explore a bounded
range of scales.  Since the integral does not diverge for $k > 0$ you get a
meaningful result.  Our PS code currently has to start at $k=0$ and go
up to $k_{\rm max}$.

For the second test, which doesn't diverge, 
I believe the difference is related to the fact that our discrete
representation of the $P(k)$ is in fact merely one complete cell of an infinite
periodic series. This is what the Discrete Fourier Transform of a
finite set of samples actually represents, just as the assumption is
implicit that the samples in real space are also one cell of a
periodic series.

What is being assumed here is that our representation in $k$ spaces is
of some sort of 2D boxcar that is $P_0$ up to $k_{\rm max}$, and then
zero outside.  This is not the case: because we are representing delta
function samples in real space the periodic series extends to positive
and negative infinity in both $k$ directions.  So our representation
of the power spectrum is not in fact bounded.

We know that the Fourier Transform of a flat function of value $P_0$ gives a Dirac delta
function of area proportional to $P_0$.  So this is encouraging.  But
then what is the source of the contradiction with with equation (5)?  I think the issue is that
care needs to be taken with the Bessel function $J_0(k \theta)$, which
is highly oscillatory as $\theta \rightarrow 0$.  It might be simpler
to treat the integral in Cartesian coordinates before setting $\theta=0$:
\begin{equation}
\xi_{\pm}(\theta) = \frac{P_0}{2 \pi} \int \! e^{ik_x \theta_x} dk_x
\int \! e^{i k_y \theta_y} dk_y.
\end{equation}
The integrals on the RHS are the well known expressions for delta
functions.  So we have
\begin{equation}
\xi_{\pm}(\theta) = \frac{P_0}{2 \pi} \delta(\theta_x) \delta(\theta_y)
\end{equation}
rather than an integral which diverges for large positive $k$ if you
put $P(k) = P_0$ into equation (5).

Both these test cases seem slightly problematic, so we should try a simple
power spectrum that is guaranteed to be finite area and bounded within
our periodic cells.  A suggestion is the Gaussian.  If we have $P(k) =
e^{-\sigma^2 k^2 / 2}$ then we should get $\xi_+(\theta) =
e^{-\theta^2/2\sigma^2}/(2 \pi \sigma^2)$ (I think)...


\textbf{Didn't try the stuff that comes after this (yet):}

Unit conversions, $P$ vs. $\Delta^2$, and scale-dependence of shear
correlation functions / power spectra.

\end{document}
